(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.React,n=window.wp.plugins,i=window.wp.editPost,a=window.wp.i18n,r=window.wp.element,s=window.wp.data,l=window.wp.components,o=window.wp.apiFetch;var d=e.n(o);const m=({revision:e,isFirst:n,isLast:i,onSetCurrent:r,disabled:s})=>{const{id:o,title:d,author:m,date:c,status:g,is_current:v,excerpt:w}=e,u=e=>{switch(e){case"current":return(0,a.__)("Current","dgwltd-revision-manager");case"pending":return(0,a.__)("Pending","dgwltd-revision-manager");case"past":return(0,a.__)("Past","dgwltd-revision-manager");default:return(0,a.__)("Unknown","dgwltd-revision-manager")}};return(0,t.createElement)("div",{className:`dgw-timeline-item dgw-timeline-item--${g} ${v?"dgw-timeline-item--current":""}`},(0,t.createElement)("div",{className:"dgw-timeline-marker"},(0,t.createElement)("span",{className:"dgw-timeline-icon",role:"img","aria-label":u(g)},(e=>{switch(e){case"current":return"●";case"pending":return"◒";default:return"○"}})(g))),(0,t.createElement)("div",{className:"dgw-timeline-content"},(0,t.createElement)("div",{className:"dgw-timeline-header"},(0,t.createElement)("h4",{className:"dgw-timeline-title"},d||(0,a.__)("(No title)","dgwltd-revision-manager")),(0,t.createElement)("span",{className:`dgw-timeline-status dgw-timeline-status--${g}`},u(g))),(0,t.createElement)("div",{className:"dgw-timeline-meta"},(0,t.createElement)("span",{className:"dgw-timeline-author"},(0,a.__)("By","dgwltd-revision-manager")," ",m),(0,t.createElement)("span",{className:"dgw-timeline-date"},new Date(c).toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}))),w&&(0,t.createElement)("p",{className:"dgw-timeline-excerpt"},w),(0,t.createElement)("div",{className:"dgw-timeline-actions"},!v&&(0,t.createElement)(l.Button,{isSmall:!0,isSecondary:!0,onClick:r,disabled:s},(0,a.__)("Set as Current","dgwltd-revision-manager")),(0,t.createElement)(l.Button,{isSmall:!0,isTertiary:!0,href:`/wp-admin/revision.php?revision=${o}`,target:"_blank"},(0,a.__)("View","dgwltd-revision-manager")))))},c=({revisionData:e,onRevisionChange:n})=>{const[i,s]=(0,r.useState)(!1),[o,c]=(0,r.useState)(null),[g,v]=(0,r.useState)(null),{timeline:w,current_revision_id:u,total_revisions:_}=e,p=()=>{v(null)};return w&&0!==w.length?(0,t.createElement)("div",{className:"dgw-revision-timeline"},o&&(0,t.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>c(null)},o),(0,t.createElement)("div",{className:"dgw-timeline-header"},(0,t.createElement)("p",{className:"dgw-timeline-meta"},_," ",1===_?(0,a.__)("revision","dgwltd-revision-manager"):(0,a.__)("revisions","dgwltd-revision-manager"))),(0,t.createElement)("div",{className:"dgw-timeline-container"},(0,t.createElement)("div",{className:"dgw-timeline-line"}),w.map((e,n)=>(0,t.createElement)(m,{key:e.id,revision:e,isFirst:0===n,isLast:n===w.length-1,onSetCurrent:()=>(e=>{v(e)})(e),disabled:i}))),g&&(0,t.createElement)(l.Modal,{title:(0,a.__)("Set Revision as Current","dgwltd-revision-manager"),onRequestClose:p,className:"dgw-confirm-modal"},(0,t.createElement)("p",null,(0,a.__)("Are you sure you want to set this revision as the current version?","dgwltd-revision-manager")),(0,t.createElement)("div",{className:"dgw-modal-revision-preview"},(0,t.createElement)("h4",null,g.title||(0,a.__)("(No title)","dgwltd-revision-manager")),(0,t.createElement)("p",{className:"dgw-revision-meta"},(0,a.__)("By","dgwltd-revision-manager")," ",g.author," • ",new Date(g.date).toLocaleDateString()),g.excerpt&&(0,t.createElement)("p",{className:"dgw-revision-excerpt"},g.excerpt)),(0,t.createElement)("div",{className:"dgw-modal-actions"},(0,t.createElement)(l.Button,{isSecondary:!0,onClick:p,disabled:i},(0,a.__)("Cancel","dgwltd-revision-manager")),(0,t.createElement)(l.Button,{isPrimary:!0,onClick:()=>(async e=>{s(!0),c(null);try{(await d()({path:`/dgw-revision-manager/v1/revisions/${e}/set-current`,method:"POST"})).success?(n(),v(null)):c((0,a.__)("Failed to set revision as current.","dgwltd-revision-manager"))}catch(e){c((0,a.__)("Error setting revision as current.","dgwltd-revision-manager")),console.error("Error setting current revision:",e)}finally{s(!1)}})(g.id),disabled:i},i?(0,t.createElement)(l.Spinner,null):(0,a.__)("Set as Current","dgwltd-revision-manager"))))):(0,t.createElement)("div",{className:"dgw-timeline-empty"},(0,t.createElement)("p",null,(0,a.__)("No revisions found for this post.","dgwltd-revision-manager")))},g=()=>{const[e,n]=(0,r.useState)(!1),[i,o]=(0,r.useState)(null),[m,g]=(0,r.useState)("open"),[v,w]=(0,r.useState)(null),u=(0,s.useSelect)(e=>e("core/editor").getCurrentPostId(),[]),_=((0,s.useSelect)(e=>e("core/editor").getCurrentPostType(),[]),(0,s.useSelect)(e=>{const t=e("core/editor").getCurrentPost();return t?.link||""},[])),{createNotice:p,removeNotice:E}=(0,s.useDispatch)("core/notices");(0,r.useEffect)(()=>{u&&h()},[u]),(0,r.useEffect)(()=>{const e="dgw-content-mismatch";if(E(e),"pending"===m&&i&&i.timeline&&i.timeline.length>0){const t=i.timeline.find(e=>e.is_current),n=i.timeline[0];t&&n&&t.id!==n.id&&p("warning",(0,a.__)("You are editing content that differs from what visitors see. Latest changes are not yet published.","dgwltd-revision-manager"),{id:e,isDismissible:!0,actions:[{label:(0,a.__)("View Published Version","dgwltd-revision-manager"),onClick:()=>window.open(_,"_blank")},{label:(0,a.__)("Publish Latest Changes","dgwltd-revision-manager"),onClick:()=>N()}]})}},[m,i,_,p,E]);const h=async()=>{n(!0),w(null);try{const e=await d()({path:`/dgw-revision-manager/v1/revisions/${u}`});o(e),g(e.revision_mode||"open")}catch(e){w((0,a.__)("Failed to load revision data.","dgwltd-revision-manager")),console.error("Error loading revision data:",e)}finally{n(!1)}},N=async()=>{if(!i||!i.timeline||0===i.timeline.length)return;const e=i.timeline[0];n(!0),w(null);try{(await d()({path:`/dgw-revision-manager/v1/revisions/${e.id}/set-current`,method:"POST"})).success?(E("dgw-content-mismatch"),await h()):w((0,a.__)("Failed to publish latest changes.","dgwltd-revision-manager"))}catch(e){w((0,a.__)("Error publishing latest changes.","dgwltd-revision-manager")),console.error("Error setting latest as current:",e)}finally{n(!1)}};return u?(0,t.createElement)("div",{className:"dgw-revision-manager-panel"},v&&(0,t.createElement)(l.Notice,{status:"error",isDismissible:!0,onRemove:()=>w(null)},v),(0,t.createElement)(l.PanelBody,{title:(0,a.__)("Revision Manager","dgwltd-revision-manager"),initialOpen:!0},(0,t.createElement)(l.RadioControl,{label:(0,a.__)("Revision Mode","dgwltd-revision-manager"),selected:m,onChange:async e=>{n(!0),w(null);try{await d()({path:`/dgw-revision-manager/v1/revisions/${u}/mode`,method:"PUT",data:{mode:e}}),g(e),await h()}catch(e){w((0,a.__)("Failed to update revision mode.","dgwltd-revision-manager")),console.error("Error updating revision mode:",e)}finally{n(!1)}},disabled:e,options:[{label:(0,a.__)("Standard WordPress Revisions","dgwltd-revision-manager"),value:"open"},{label:(0,a.__)("Requires Approval","dgwltd-revision-manager"),value:"pending"}],help:(0,a.__)("Choose how revisions are managed for this post.","dgwltd-revision-manager")}),"open"===m&&(0,t.createElement)("p",{className:"description"},(0,a.__)("All changes are saved automatically as revisions using standard WordPress behavior.","dgwltd-revision-manager")),e&&(0,t.createElement)(l.Spinner,null)),"pending"===m&&(0,t.createElement)(l.PanelBody,{title:(0,a.__)("Revision Timeline","dgwltd-revision-manager"),initialOpen:!0},e?(0,t.createElement)("div",{className:"dgw-loading-container"},(0,t.createElement)(l.Spinner,null),(0,t.createElement)("p",null,(0,a.__)("Loading timeline...","dgwltd-revision-manager"))):i?(0,t.createElement)(c,{revisionData:i,onRevisionChange:()=>{h()}}):(0,t.createElement)("p",null,(0,a.__)("No revision data available.","dgwltd-revision-manager")),(0,t.createElement)("div",{className:"dgw-panel-actions"},(0,t.createElement)(l.Button,{isSecondary:!0,onClick:h,disabled:e},(0,a.__)("Refresh","dgwltd-revision-manager"))))):(0,t.createElement)(l.PanelBody,{title:(0,a.__)("Revision Manager","dgwltd-revision-manager")},(0,t.createElement)("p",null,(0,a.__)("Save the post to enable revision management.","dgwltd-revision-manager")))};(0,n.registerPlugin)("dgw-revision-manager",{render:()=>(0,t.createElement)(r.Fragment,null,(0,t.createElement)(i.PluginSidebarMoreMenuItem,{target:"dgw-revision-manager",icon:"backup"},(0,a.__)("Revision Manager","dgwltd-revision-manager")),(0,t.createElement)(i.PluginSidebar,{name:"dgw-revision-manager",title:(0,a.__)("Revision Manager","dgwltd-revision-manager"),icon:"backup"},(0,t.createElement)(g,null))),icon:"backup"})})();